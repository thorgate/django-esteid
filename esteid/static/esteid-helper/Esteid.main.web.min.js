(()=>{var o="EST",d="ENG",l="RUS",c="LIT",R=[o,d,l,c],k={user_cancel:{[o]:"Allkirjastamine katkestati",[d]:"Signing was cancelled",[c]:"Pasira\u0161ymas nutrauktas",[l]:"\u041F\u043E\u0434\u043F\u0438\u0441\u044C \u0431\u044B\u043B\u0430 \u043E\u0442\u043C\u0435\u043D\u0435\u043D\u0430"},no_certificates:{[o]:"Sertifikaate ei leitud",[d]:"Certificate not found",[c]:"Nerastas sertifikatas",[l]:"\u0421\u0435\u0440\u0442\u0438\u0444\u0438\u043A\u0430\u0442 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"},invalid_argument:{[o]:"Vigane sertifikaadi identifikaator",[d]:"Invalid certificate identifier",[c]:"Neteisingas sertifikato identifikatorius",[l]:"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 \u0441\u0435\u0440\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u0430"},no_implementation:{[o]:"Vajalik tarkvara on puudu",[d]:"Unable to find software",[c]:"Nerasta programin\u0117s \u012Franga",[l]:"\u041E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0435 \u043F\u0440\u043E\u0433\u0440\u0430\u043C\u043C\u043D\u043E\u0435 \u043E\u0431\u0435\u0441\u043F\u0435\u0447\u0435\u043D\u0438\u0435"},version_mismatch:{[o]:"Allkirjastamise tarkvara ja brauseri laienduse versioonid ei \xFChti. Palun uuendage oma id-kaardi tarkvara.",[d]:"The versions of the signing software and browser extension do not match. Please update your ID card software.",[c]:"Parakst\u012B\u0161anas programmas un p\u0101rl\u016Bka papla\u0161in\u0101juma versijas nesakr\u012Bt. L\u016Bdzu, atjauniniet savu ID kartes programmat\u016Bru.",[l]:"\u0412\u0435\u0440\u0441\u0438\u0438 \u043F\u0440\u043E\u0433\u0440\u0430\u043C\u043C\u044B \u0434\u043B\u044F \u043F\u043E\u0434\u043F\u0438\u0441\u0430\u043D\u0438\u044F \u0438 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430 \u043D\u0435 \u0441\u043E\u0432\u043F\u0430\u0434\u0430\u044E\u0442. \u041F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u043F\u0440\u043E\u0433\u0440\u0430\u043C\u043C\u043D\u043E\u0435 \u043E\u0431\u0435\u0441\u043F\u0435\u0447\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u0432\u0430\u0448\u0435\u0439 \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u043E\u043D\u043D\u043E\u0439 \u043A\u0430\u0440\u0442\u044B."},technical_error:{[o]:"Tehniline viga",[d]:"Technical error",[c]:"Technin\u0117 klaida",[l]:"\u0422\u0435\u0445\u043D\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430"},not_allowed:{[o]:"Veebis allkirjastamise k\xE4ivitamine on v\xF5imalik vaid https aadressilt",[d]:"Web signing is allowed only from https:// URL",[c]:"Web signing is allowed only from https:// URL",[l]:"\u041F\u043E\u0434\u043F\u0438\u0441\u044C \u0432 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0435 \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u0430 \u0442\u043E\u043B\u044C\u043A\u043E \u0441 URL-\u043E\u0432, \u043D\u0430\u0447\u0438\u043D\u0430\u044E\u0449\u0438\u0445\u0441\u044F \u0441 https://"}},m=class{constructor(e){this.language=e||o,this.certificate=null,this.supportedSignatureAlgorithms=null,this.signatureAlgorithm=null}initializeIdCard(){return new Promise(function(e,t){typeof window.webeid<"u"?e("web-eid"):typeof window.hwcrypto<"u"&&window.hwcrypto.use("auto")?e("hwcrypto"):t("Backend selection failed")})}getCertificate(){return new Promise((e,t)=>{let i={lang:this.language};window.webeid.getSigningCertificate(i).then(({certificate:n,supportedSignatureAlgorithms:s})=>{this.certificate=n,this.supportedSignatureAlgorithms=s,e(n)},n=>{t(n)})})}signHexData(e,t="SHA-256"){return new Promise((i,n)=>{let s={lang:this.language};window.webeid.sign(this.certificate,e,t,s).then(r=>{this.signatureAlgorithm=r.signatureAlgorithm,i(r.signature)},r=>{n(r)})})}authenticate(e,t){let i={lang:this.language,...t};return new Promise((n,s)=>window.webeid.authenticate(e,i).then(r=>{n(r)},r=>{s(r)}))}get language(){return this._language}set language(e){R.indexOf(e)!==-1&&(this._language=e)}getWebeidErrorMapping(e){switch((e?e.code:null)||null){case"ERR_WEBEID_CONTEXT_INSECURE":return"not_allowed";case"ERR_WEBEID_ACTION_TIMEOUT":return"technical_error";case"ERR_WEBEID_USER_CANCELLED":case"ERR_WEBEID_USER_TIMEOUT":return"user_cancel";case"ERR_WEBEID_VERSION_MISMATCH":case"ERR_WEBEID_VERSION_INVALID":return"version_mismatch";case"ERR_WEBEID_EXTENSION_UNAVAILABLE":case"ERR_WEBEID_NATIVE_UNAVAILABLE":return"no_implementation";case"ERR_WEBEID_NATIVE_FATAL":return e.message.includes("https")?"not_allowed":"technical_error";default:case"ERR_WEBEID_UNKNOWN_ERROR":case"ERR_WEBEID_NATIVE_INVALID_ARGUMENT":case"ERR_WEBEID_ACTION_PENDING":case"ERR_WEBEID_MISSING_PARAMETER":return"technical_error"}}getError(e){let t;return typeof k[e]>"u"?t=this.getWebeidErrorMapping(e)||"technical_error":t=e,{error_code:t,message:k[t][this.language],raw:e}}},_=m;var g=async(E,e,t="POST")=>{let i={"Content-Type":"application/json"},n=null;t!=="GET"&&(i["X-CSRFToken"]=e.csrfmiddlewaretoken,n=JSON.stringify(e||{}));try{let s=await fetch(E,{method:t,headers:i,body:n}),r=await s.text();try{let a=JSON.parse(r);return a.success=a.status==="success",a.pending=`${s.status}`=="202",{data:a,ok:s.ok}}catch{return console.log("Failed to parse response as JSON",r),{}}}catch(s){return console.log(s),{}}},p=class{constructor({language:e,idUrl:t,mobileIdUrl:i,smartIdUrl:n,csrfToken:s,pollInterval:r}){this.idCardManager=new _(e),this.idUrl=t,this.mobileIdUrl=i,this.smartIdUrl=n,this.csrfToken=s,this.language=e,this.pollInterval=r||3e3}checkStatus(e,t,i){let n=this.pollInterval,s=this.csrfToken,r=()=>{g(e,{csrfmiddlewaretoken:s},"PATCH").then(({ok:a,data:h})=>{a&&h.pending?setTimeout(()=>r(),n):a&&h.success?t(h):i(h)}).catch(a=>{console.log("Status error",a)})};return r()}signWithIdCard(){return new Promise((e,t)=>{this.__signHandleIdCard(e,t)})}signWithMobileId({idCode:e,phoneNumber:t}){return new Promise((i,n)=>{this.__signHandleMid(e,t,i,n)})}signWithSmartId({idCode:e,country:t}){return new Promise((i,n)=>{this.__signHandleSmartid(e,t,i,n)})}__signHandleIdCard(e,t){this.idCardManager.initializeIdCard().then(()=>{this.idCardManager.getCertificate().then(i=>{g(this.idUrl,{csrfmiddlewaretoken:this.csrfToken,certificate:i}).then(({ok:n,data:s})=>{n&&s.success?this.__doSign(s.digest,e,t):t(s)})},t)},t)}__doSign(e,t,i){this.idCardManager.signHexData(e).then(n=>{g(this.idUrl,{csrfmiddlewaretoken:this.csrfToken,signature_value:n},"PATCH").then(({ok:s,data:r})=>{s&&r.success?t(r):i(r)})},i)}__signHandleMid(e,t,i,n){g(this.mobileIdUrl,{id_code:e,phone_number:t,language:this.language,csrfmiddlewaretoken:this.csrfToken}).then(({ok:s,data:r})=>{s&&r.success?i(r):n(r)})}midStatus(){return new Promise((e,t)=>{this.checkStatus(this.mobileIdUrl,e,t)})}__signHandleSmartid(e,t,i,n){g(this.smartIdUrl,{id_code:e,country:t,csrfmiddlewaretoken:this.csrfToken}).then(({ok:s,data:r})=>{s&&r.success?i(r):n(r)})}smartidStatus(){return new Promise((e,t)=>{this.checkStatus(this.smartIdUrl,e,t)})}authenticateWithIdCard(e){return new Promise((t,i)=>{g(this.idUrl,{csrfmiddlewaretoken:this.csrfToken},"POST").then(({ok:n,data:s})=>{if(n&&s.pending)return this.idCardManager.initializeIdCard().then(()=>this.idCardManager.authenticate(s.nonce,e||{}).then(r=>g(this.idUrl,{csrfmiddlewaretoken:this.csrfToken,...r},"PATCH").then(({ok:a,data:h})=>{a&&h.success?t(h):i(h)},i),r=>{if(r.code==="ERR_WEBEID_USER_CANCELLED")return g(this.idUrl,{csrfmiddlewaretoken:this.csrfToken},"DELETE").then(()=>{i(r)},i);i(r)}),i);i(s)})})}getError(e){return this.idCardManager.getError(e)}},I=p;function f(E,e){let t=Object.entries(e).map(([i,n])=>`${encodeURIComponent(i)}=${encodeURIComponent(n)}`).join("&");return fetch(E,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t}).then(i=>i.json().then(n=>({data:n,ok:i.ok})),i=>(console.log(i),{}))}var u=class{constructor(e){let t={language:null,idEndpoints:{start:null,finish:null,finalize:null},midEndpoints:{start:null,status:null,finalize:null},smartidEndpoints:{start:null,status:null,finalize:null},...e};this.idCardManager=new _(t.language),this.idEndpoints=t.idEndpoints,this.midEndpoints=t.midEndpoints,this.smartidEndpoints=t.smartidEndpoints}checkStatus(e,t,i,n){let s=()=>{f(e,t).then(({ok:r,data:a})=>{r&&a.pending?setTimeout(()=>s(),1e3):r&&a.success?i(a):n(a)})};return s}signWithIdCard(e){return new Promise((t,i)=>{this.__signHandleId(e,t,i)})}signWithMobileId(e){return new Promise((t,i)=>{this.__signHandleMid(e,t,i)})}signWithSmartId(e){return new Promise((t,i)=>{this.__signHandleSmartid(e,t,i)})}sign(e,t){if(e===u.SIGN_ID)return this.signWithIdCard(t);if(e===u.SIGN_MOBILE)return this.signWithMobileId(t);if(e===u.SIGN_SMARTID)return this.signWithSmartId(t);throw new TypeError("LegacyIdentificationManager: Bad signType")}__signHandleId(e,t,i){this.idCardManager.initializeIdCard().then(()=>{this.idCardManager.getCertificate().then(n=>{f(this.idEndpoints.start,{...e,certificate:n}).then(({ok:s,data:r})=>{s&&r.success?this.__doSign(r.digest,e,t,i):i(r)})},i)},i)}__doSign(e,t,i,n){this.idCardManager.signHexData(e).then(s=>{f(this.idEndpoints.finish,{...t,signature_value:s}).then(({ok:r,data:a})=>{r&&a.success?i(a):n(a)})},n)}__signHandleMid(e,t,i){f(this.midEndpoints.start,e).then(({ok:n,data:s})=>{n&&s.success?t(s):i(s)})}midStatus(e){return new Promise((t,i)=>{this.checkStatus(this.midEndpoints.status,e,t,i)()})}__signHandleSmartid(e,t,i){f(this.smartidEndpoints.start,e).then(({ok:n,data:s})=>{n&&s.success?t(s):i(s)})}smartidStatus(e){return new Promise((t,i)=>{this.checkStatus(this.smartidEndpoints.status,e,t,i)()})}getError(e){return this.idCardManager.getError(e)}};u.SIGN_ID="id";u.SIGN_MOBILE="mid";u.SIGN_SMARTID="smartid";var w=u;var T={ET:o,EN:d,RU:l,LT:c};var S={IdentificationManager:I,LegacyIdentificationManager:w,Languages:T};var A=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{};A.Esteid=S;var O=S;})();
